Bootstrap: docker
From: ros:noetic-perception

%post
    export XDG_CACHE_HOME=/tmp/singularity-cache # pip cache

    # Install Apt packages
    packages="
    gcc
    g++
    bridge-utils
    build-essential
    htop
    net-tools
    screen
    sshpass
    tmux
    vim
    wget
    curl
    git
    python3-pip
    python3-catkin-tools
    ros-noetic-ros-numpy
    ros-noetic-rviz
    "
    apt-get update
    apt-get install -y ${packages}

    # Install Python packages
    python_pkgs="
    iopath
    fvcore
    tensorboard
    dgp==0.0.91
    matplotlib==3.4.3
    open3d==0.10.0.0
    opencv_python==4.5.4.58
    pandas==1.3.4
    Pillow==9.0.1
    requests==2.26.0
    scipy==1.7.2
    setuptools==58.0.4
    tifffile==2021.11.2
    tqdm==4.62.3
    "
    pip install ${python_pkgs}
    # pytorch
    #pip install torch==1.10.1+cu113 -f https://download.pytorch.org/whl/torch_stable.html
    pip install torch==1.10.1 --extra-index-url https://download.pytorch.org/whl/cu113
    # Pytorch3d
    pip install --no-index --no-cache-dir pytorch3d -f https://dl.fbaipublicfiles.com/pytorch3d/packaging/wheels/py38_cu113_pyt1101/download.html
    # GradSLAM
    pip install 'git+https://github.com/gradslam/gradslam.git'
    ln -s /usr/bin/python3 /usr/bin/python

    # Build ROS workspace
    ws=/opt/ros/depthcorr_ws
    mkdir -p "${ws}/src/"
    cd "${ws}/src"
    git clone https://github.com/RuslanAgishev/supervised_depth_correction.git
    cd "${ws}"
    njobs=`grep ^cpu\\\\scores /proc/cpuinfo | uniq | awk '{print $4}'`
    catkin init
    catkin config --extend /opt/ros/noetic
    catkin build -c -j $njobs

%runscript
    echo "Running demo example on bag file"
    /bin/bash -c "source /opt/ros/noetic/setup.bash && \
                  source /opt/ros/depthcorr_ws/devel/setup.bash --extend && \
                  roslaunch supervised_depth_correction demo.launch rviz:=0"
